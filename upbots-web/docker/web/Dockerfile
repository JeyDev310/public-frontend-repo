ARG PROJECT_DIR=/app


FROM node:14.17.3-alpine as builder
RUN apk add git
ARG PROJECT_DIR
WORKDIR $PROJECT_DIR


ARG VUE_APP_ROOT_API
ARG VUE_APP_LOCAL_STORAGE_TOKEN_NAME
ARG VUE_APP_LOCAL_STORAGE_USER_NAME
ARG VUE_APP_CP_LTCT_ADDRESS
ARG VUE_APP_CP_IPNS_HANDLER
ARG VUE_APP_CP_SUCCESS_UR
ARG VUE_APP_CP_CANCEL_URL
ARG VUE_APP_ETH_USDT_PAIR_ADDRESS
ARG VUE_APP_LP_ADDRESS
ARG VUE_APP_STAKING_ADDRESS
ARG VUE_APP_STAKING_PROMONAME
ARG VUE_APP_UBXG_ADDRESS
ARG VUE_APP_UBXT_ADDRESS
ARG VUE_APP_UBXT_PAIR_ADDRESS
ARG VUE_APP_BSC_STAKING_ADDRESS
ARG VUE_APP_BSC_UBXT_ADDRESS
ARG VUE_APP_BSC_LP_ADDRESS
ARG VUE_APP_BSC_UBXT_PAIR_ADDRESS
ARG VUE_APP_VAULT_ADDRESS
ARG VUE_APP_RECAPTCHA_SITE_KEY
ARG VUE_APP_WEB3_PROVIDER_INFURA
ARG VUE_APP_WEB3_UBXTOKEN_PROXY_CONTRACT_ADDRESS
ARG VUE_APP_WEB3_CALLBACK_TIMER
ARG VUE_APP_WEB3_PROVIDER_COINGECKO_API_ETHEREUM
ARG VUE_APP_ENABLE_PERF_FEES_FEATURE
ARG VUE_APP_BETA_SERVER
ARG VUE_APP_WEB3_BSC_RPC_ENDPOINT
ARG VUE_APP_WEB3_PROVIDER_INFURA_ID
ARG VUE_APP_GA_ID
ARG VUE_APP_UBXT_TOKEN
ARG VUE_APP_INDACOIN_URL
ARG VUE_APP_BUILD_SCRIPT


COPY tsconfig.json $PROJECT_DIR/tsconfig.json
COPY postcss.config.js $PROJECT_DIR/postcss.config.js
COPY tailwind.config.js $PROJECT_DIR/tailwind.config.js
COPY babel.config.js $PROJECT_DIR/babel.config.js
COPY vue.config.prod.js $PROJECT_DIR/vue.config.js

COPY package*.json $PROJECT_DIR/

ENV VUE_APP_ROOT_API $VUE_APP_ROOT_API
ENV VUE_APP_LOCAL_STORAGE_TOKEN_NAME $VUE_APP_LOCAL_STORAGE_TOKEN_NAME
ENV VUE_APP_LOCAL_STORAGE_USER_NAME $VUE_APP_LOCAL_STORAGE_USER_NAME
ENV VUE_APP_CP_LTCT_ADDRESS $VUE_APP_CP_LTCT_ADDRESS
ENV VUE_APP_CP_IPNS_HANDLER $VUE_APP_CP_IPNS_HANDLER
ENV VUE_APP_CP_SUCCESS_UR $VUE_APP_CP_SUCCESS_UR
ENV VUE_APP_CP_CANCEL_URL $VUE_APP_CP_CANCEL_URL
ENV VUE_APP_ETH_USDT_PAIR_ADDRESS $VUE_APP_ETH_USDT_PAIR_ADDRESS
ENV VUE_APP_LP_ADDRESS $VUE_APP_LP_ADDRESS
ENV VUE_APP_STAKING_ADDRESS $VUE_APP_STAKING_ADDRESS
ENV VUE_APP_STAKING_PROMONAME $VUE_APP_STAKING_PROMONAME
ENV VUE_APP_UBXG_ADDRESS $VUE_APP_UBXG_ADDRESS
ENV VUE_APP_UBXT_ADDRESS $VUE_APP_UBXT_ADDRESS
ENV VUE_APP_UBXT_PAIR_ADDRESS $VUE_APP_UBXT_PAIR_ADDRESS
ENV VUE_APP_BSC_STAKING_ADDRESS $VUE_APP_BSC_STAKING_ADDRESS
ENV VUE_APP_BSC_UBXT_ADDRESS $VUE_APP_BSC_UBXT_ADDRESS
ENV VUE_APP_BSC_LP_ADDRESS $VUE_APP_BSC_LP_ADDRESS
ENV VUE_APP_BSC_UBXT_PAIR_ADDRESS $VUE_APP_BSC_UBXT_PAIR_ADDRESS
ENV VUE_APP_VAULT_ADDRESS $VUE_APP_VAULT_ADDRESS
ENV VUE_APP_RECAPTCHA_SITE_KEY $VUE_APP_RECAPTCHA_SITE_KEY
ENV VUE_APP_WEB3_PROVIDER_INFURA $VUE_APP_WEB3_PROVIDER_INFURA
ENV VUE_APP_WEB3_UBXTOKEN_PROXY_CONTRACT_ADDRESS $VUE_APP_WEB3_UBXTOKEN_PROXY_CONTRACT_ADDRESS
ENV VUE_APP_WEB3_CALLBACK_TIMER $VUE_APP_WEB3_CALLBACK_TIMER
ENV VUE_APP_WEB3_PROVIDER_COINGECKO_API_ETHEREUM $VUE_APP_WEB3_PROVIDER_COINGECKO_API_ETHEREUM
ENV VUE_APP_ENABLE_PERF_FEES_FEATURE $VUE_APP_ENABLE_PERF_FEES_FEATURE
ENV VUE_APP_BETA_SERVER $VUE_APP_BETA_SERVER
ENV VUE_APP_WEB3_BSC_RPC_ENDPOINT $VUE_APP_WEB3_BSC_RPC_ENDPOINT
ENV VUE_APP_WEB3_PROVIDER_INFURA_ID $VUE_APP_WEB3_PROVIDER_INFURA_ID
ENV VUE_APP_GA_ID $VUE_APP_GA_ID
ENV VUE_APP_UBXT_TOKEN $VUE_APP_UBXT_TOKEN
ENV VUE_APP_INDACOIN_URL $VUE_APP_INDACOIN_URL
ENV VUE_APP_BUILD_SCRIPT $VUE_APP_BUILD_SCRIPT


# NODE ENV SHOULD BE AFTER NPM INSTALL TO AVOID vue/cli-service not found error
# no need will be set by vue/cli-service
# ENV NODE_ENV=production

RUN npm ci

COPY /public $PROJECT_DIR/public

COPY /tests $PROJECT_DIR/tests
COPY /src $PROJECT_DIR/src
COPY .eslintrc.js  $PROJECT_DIR/.eslintrc.js

ARG NODE_ENV
ENV NODE_ENV $NODE_ENV

# COPY /.env.production $PROJECT_DIR/.env.production


RUN npm run $VUE_APP_BUILD_SCRIPT  

# FROM abiosoft/caddy:1.0.0-no-stats as caddy
FROM caddy:2.1.1-alpine as caddy
ARG PROJECT_DIR
COPY --from=builder $PROJECT_DIR/dist/ /srv
COPY Caddyfile /etc/caddy/Caddyfile

EXPOSE 80
